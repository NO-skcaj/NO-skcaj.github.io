name: Update Programmer Rankings

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-rankings:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}
        fetch-depth: 0
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Fetch org members and update HTML
      env:
        GITHUB_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        ORG_NAME: 'HVA-FRC-3824'
        TEAM_SLUG: 'programmers'
      run: |
        node << 'EOF'
        const https = require('https');
        const fs = require('fs');

        const ORG_NAME = process.env.ORG_NAME;
        const TEAM_SLUG = process.env.TEAM_SLUG;
        const TOKEN = process.env.GITHUB_TOKEN;

        function httpsGet(url) {
          return new Promise((resolve, reject) => {
            https.get(url, {
              headers: {
                'User-Agent': 'GitHub-Actions',
                'Authorization': `Bearer ${TOKEN}`,
                'Accept': 'application/vnd.github+json',
                'X-GitHub-Api-Version': '2022-11-28'
              }
            }, (res) => {
              let data = '';
              res.on('data', chunk => data += chunk);
              res.on('end', () => {
                if (res.statusCode === 200) {
                  resolve(JSON.parse(data));
                } else {
                  reject(new Error(`HTTP ${res.statusCode}: ${data}`));
                }
              });
            }).on('error', reject);
          });
        }

        async function getTeamMembers() {
          console.log(`Fetching members of team: ${TEAM_SLUG}...`);
          const url = `https://api.github.com/orgs/${ORG_NAME}/teams/${TEAM_SLUG}/members?per_page=100`;
          return await httpsGet(url);
        }

        async function getOrgMembers() {
          console.log('Fetching organization members (fallback)...');
          const url = `https://api.github.com/orgs/${ORG_NAME}/members?per_page=100`;
          return await httpsGet(url);
        }

        async function getUserCommits(username) {
          const reposUrl = `https://api.github.com/orgs/${ORG_NAME}/repos?per_page=100`;
          const repos = await httpsGet(reposUrl);
          
          let totalCommits = 0;
          
          for (const repo of repos) {
            try {
              // Use the commits endpoint with author filter
              const commitsUrl = `https://api.github.com/repos/${ORG_NAME}/${repo.name}/commits?author=${username}&per_page=100`;
              
              const response = await new Promise((resolve, reject) => {
                https.get(commitsUrl, {
                  headers: {
                    'User-Agent': 'GitHub-Actions',
                    'Authorization': `Bearer ${TOKEN}`,
                    'Accept': 'application/vnd.github+json',
                    'X-GitHub-Api-Version': '2022-11-28'
                  }
                }, (res) => {
                  let data = '';
                  res.on('data', chunk => data += chunk);
                  res.on('end', () => resolve({ 
                    statusCode: res.statusCode, 
                    data, 
                    headers: res.headers 
                  }));
                }).on('error', reject);
              });
              
              if (response.statusCode === 200) {
                const commits = JSON.parse(response.data);
                const commitCount = commits.length;
                
                // Check if there are more pages
                const linkHeader = response.headers.link;
                if (linkHeader && linkHeader.includes('rel="last"')) {
                  // Extract the last page number
                  const match = linkHeader.match(/page=(\d+)>; rel="last"/);
                  if (match) {
                    const lastPage = parseInt(match[1]);
                    // Rough estimate: lastPage * 100 commits per page
                    totalCommits += lastPage * 100;
                  } else {
                    totalCommits += commitCount;
                  }
                } else {
                  totalCommits += commitCount;
                }
              }
              
              await new Promise(resolve => setTimeout(resolve, 200));
            } catch (err) {
              console.log(`  Error in ${repo.name}: ${err.message}`);
            }
          }
          
          return totalCommits;
        }

        async function main() {
          console.log('=== Starting Rankings Update ===');
          console.log(`Organization: ${ORG_NAME}`);
          console.log(`Team: ${TEAM_SLUG}`);
          
          let members;
          
          try {
            members = await getTeamMembers();
            console.log(`✓ Found ${members.length} team members`);
          } catch (err) {
            console.log(`✗ Could not fetch team members: ${err.message}`);
            console.log('Falling back to organization members...');
            members = await getOrgMembers();
            console.log(`✓ Found ${members.length} organization members`);
          }
          
          const commitCounts = {};
          
          console.log('\n=== Counting commits ===');
          for (const member of members) {
            console.log(`\nChecking ${member.login}...`);
            const commits = await getUserCommits(member.login);
            commitCounts[member.login] = commits;
            console.log(`  Total: ${commits} commits`);
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
          
          const template = fs.readFileSync('index.html', 'utf8');
          
          console.log('\n=== Template Info ===');
          console.log('Template file size:', template.length, 'characters');
          console.log('Has rankings placeholder:', template.includes('const rankings'));
          console.log('Has commitCounts placeholder:', template.includes('const commitCounts'));
          
          const sortedMembers = Object.entries(commitCounts)
            .sort((a, b) => b[1] - a[1]); // Sort by commits, keep everyone including 0 commits
          
          console.log(`\nActive contributors: ${sortedMembers.length}`);
          
          const rankings = {
            'S': [],
            'A': [],
            'B': [],
            'C': [],
            'D': [],
            'E': [],
            'F': []
          };
          
          // Distribute members across tiers based on commit counts
          sortedMembers.forEach((member, index) => {
            const username = member[0];
            const ratio = index / sortedMembers.length;
            
            if (ratio < 0.10) rankings['S'].push(username);
            else if (ratio < 0.25) rankings['A'].push(username);
            else if (ratio < 0.50) rankings['B'].push(username);
            else if (ratio < 0.70) rankings['C'].push(username);
            else if (ratio < 0.85) rankings['D'].push(username);
            else if (ratio < 0.95) rankings['E'].push(username);
            else rankings['F'].push(username);
          });
          
          console.log('\n=== Tier Distribution ===');
          Object.entries(rankings).forEach(([tier, members]) => {
            if (members.length > 0) {
              console.log(`${tier}: ${members.join(', ')}`);
            }
          });
          
          const rankingsStr = JSON.stringify(rankings, null, 12).replace(/^/gm, '        ');
          const commitsStr = JSON.stringify(commitCounts, null, 12).replace(/^/gm, '        ');
          
          let updated = template.replace(
            /const rankings = \{[\s\S]*?\};/,
            `const rankings = ${rankingsStr};`
          );
          
          updated = updated.replace(
            /const commitCounts = \{[\s\S]*?\};/,
            `const commitCounts = ${commitsStr};`
          );
          
          const timestamp = new Date().toISOString().split('T')[0];
          updated = updated.replace(
            /<div class="subtitle">.*?<\/div>/,
            `<div class="subtitle"><span class="code-decoration">// </span>Last updated: ${timestamp}<span class="code-decoration"> //</span></div>`
          );
          
          fs.writeFileSync('index.html', updated);
          console.log('\n✓ HTML file updated successfully!');
          console.log(`Total members in rankings: ${sortedMembers.length}`);
          console.log('Updated file size:', fs.statSync('index.html').size, 'bytes');
          console.log('Original file size:', template.length, 'bytes');
          
          // Verify the file was actually written
          const verification = fs.readFileSync('index.html', 'utf8');
          const hasNewData = verification.includes(JSON.stringify(rankings));
          console.log('Verification - new data written:', hasNewData);
        }

        main().catch(err => {
          console.error('Fatal error:', err);
          process.exit(1);
        });
        EOF
        
    - name: Commit and push if changed
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        echo "=== Git Status ==="
        git status
        
        echo "=== Changes in index.html ==="
        git diff index.html | head -50
        
        git add index.html
        
        echo "Committing changes..."
        git commit -m "Auto-update programmer rankings [skip ci]"
        echo "Pushing to repository..."
        git push
        echo "Push complete!"
